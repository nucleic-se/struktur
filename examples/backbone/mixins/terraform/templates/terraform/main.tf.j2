terraform {
    required_providers {
        proxmox = {
            source = "Telmate/proxmox"
            version = "3.0.2-rc04"
        }
    }
}

provider "proxmox" {
    pm_api_url = var.pm_api_url
    pm_api_token_id = var.pm_api_token_id
    pm_api_token_secret = var.pm_api_token_secret
    pm_tls_insecure = var.pm_tls_insecure
}

#
# LXC Containers
# Generated from backbone_lab stack
#
{{#each instances}}
{{#if (and (eq class "proxmox_lxc") aspects.terraform.enabled)}}
resource "proxmox_lxc" "{{id}}" {
    # From data model
    vmid = {{aspects.proxmox_guest.vmid}}
    target_node = "{{aspects.proxmox_guest.host_node}}"
    hostname = "{{aspects.network_interface.hostname}}"
    
    # From data model: ostemplate
    ostemplate = "{{aspects.proxmox_guest.ostemplate}}"
    
    # From data model: cores and memory
    cores = {{aspects.compute_node.cores}}
    memory = {{aspects.compute_node.memory}}
    
    # From data model: boolean flags
    start = {{aspects.proxmox_guest.start}}
    unprivileged = {{aspects.proxmox_guest.unprivileged}}
    cmode = "{{aspects.proxmox_guest.cmode}}"
    
    # From data model: rootfs (storage from compute_node, storage location from proxmox_guest)
    rootfs {
        storage = "{{aspects.proxmox_guest.rootfs_storage}}"
        size = "{{aspects.compute_node.storage}}"
    }
    
    # From data model: network
    network {
        name = "eth0"
        bridge = "{{aspects.network_interface.bridge}}"
        ip = "{{aspects.network_interface.ip}}/24"
        hwaddr = "{{aspects.network_interface.mac}}"
        gw = "{{aspects.network_interface.gateway}}"
    }
    
    # From data model: nameserver
    nameserver = "{{aspects.network_interface.nameserver}}"
    
    # Still variable-based (sensitive data)
    ssh_public_keys = var.ssh_public_keys
}
{{/if}}
{{/each}}

