---
- name: Configure DNS server with Pi-hole
  hosts: dns
  become: yes
  environment:
    DEBIAN_FRONTEND: noninteractive
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Pi-hole dependencies
      apt:
        name:
          - curl
          - git
        state: present

    - name: Create Pi-hole setup directory
      file:
        path: /etc/pihole
        state: directory
        mode: '0755'

    - name: Create Pi-hole setupVars.conf
      copy:
        content: |
          WEBPASSWORD=
          PIHOLE_INTERFACE=eth0
          PIHOLE_DNS_1=1.1.1.1
          PIHOLE_DNS_2=1.0.0.1
          QUERY_LOGGING=true
          INSTALL_WEB_SERVER=true
          INSTALL_WEB_INTERFACE=true
          LIGHTTPD_ENABLED=true
          CACHE_SIZE=10000
          DNS_FQDN_REQUIRED=true
          DNS_BOGUS_PRIV=true
          DNSMASQ_LISTENING=all
        dest: /etc/pihole/setupVars.conf
        mode: '0644'

    - name: Download Pi-hole installer
      get_url:
        url: https://install.pi-hole.net
        dest: /tmp/pihole-install.sh
        mode: '0755'

    - name: Run Pi-hole installer
      shell: |
        /tmp/pihole-install.sh --unattended
      args:
        creates: /usr/local/bin/pihole

    - name: Deploy custom DNS entries
      copy:
        src: pihole_custom.list
        dest: /etc/pihole/custom.list
        mode: '0644'
      notify: restart pihole-FTL

    - name: Ensure Pi-hole FTL is started
      service:
        name: pihole-FTL
        state: started
        enabled: yes

    - name: Wait for DNS to be responsive
      wait_for:
        host: 192.168.68.10
        port: 53
        timeout: 60
        
  handlers:
    - name: restart pihole-FTL
      service:
        name: pihole-FTL
        state: restarted

- name: Wait for DNS service to be available
  hosts: proxy:web
  gather_facts: no
  tasks:
    - name: Wait for DNS server to respond
      wait_for:
        host: 192.168.68.10
        port: 53
        timeout: 120
      delegate_to: localhost
