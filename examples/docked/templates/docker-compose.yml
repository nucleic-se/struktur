# Generated by Struktur - Production Full-Stack Application
# 
# Architecture:
#   User → Nginx (frontend + reverse proxy) → API → PostgreSQL + Redis
#
# Services start in dependency order:
#   1. postgres, redis (infrastructure)
#   2. api (backend - waits for DB & cache)
#   3. nginx (frontend - waits for API)
#
# Health checks ensure each service is ready before dependents start.

services:
{{#each $instances_by_id}}{{#if (exists $aspects)}}{{#if (has $aspects "aspect_docker_container")}}{{#unless (eq $id "global")}}
  # {{#if description}}{{description}}{{else}}{{$id}} service{{/if}}
  {{$id}}:
{{#if $aspects.aspect_docker_container.image}}
    image: {{$aspects.aspect_docker_container.image}}
{{/if}}
{{#if $aspects.aspect_docker_container.build}}
{{#if (eq (typeof $aspects.aspect_docker_container.build) "string")}}
    build: {{$aspects.aspect_docker_container.build}}
{{else}}
    build:
      context: {{$aspects.aspect_docker_container.build.context}}
{{#if $aspects.aspect_docker_container.build.dockerfile}}
      dockerfile: {{$aspects.aspect_docker_container.build.dockerfile}}
{{/if}}
{{#if $aspects.aspect_docker_container.build.target}}
      target: {{$aspects.aspect_docker_container.build.target}}
{{/if}}
{{#if $aspects.aspect_docker_container.build.args}}
      args:
{{#each $aspects.aspect_docker_container.build.args}}
        {{@key}}: {{this}}
{{/each}}
{{/if}}
{{/if}}
{{/if}}
    container_name: {{$id}}
{{#if $aspects.aspect_docker_container.command}}
    command: {{{$aspects.aspect_docker_container.command}}}
{{/if}}
{{#if $aspects.aspect_docker_container.working_dir}}
    working_dir: {{$aspects.aspect_docker_container.working_dir}}
{{/if}}
{{#if $aspects.aspect_docker_container.restart_policy}}
    restart: {{$aspects.aspect_docker_container.restart_policy}}
{{/if}}
{{#if $aspects.aspect_docker_container.ports}}
    ports:
{{#each $aspects.aspect_docker_container.ports}}
      - "{{this}}"
{{/each}}
{{/if}}
{{#if $aspects.aspect_docker_container.volumes}}
    volumes:
{{#each $aspects.aspect_docker_container.volumes}}
      - {{this}}
{{/each}}
{{/if}}
{{#if $aspects.aspect_docker_container.environment}}
    environment:
{{#each $aspects.aspect_docker_container.environment}}
      {{@key}}: "{{{this}}}"
{{/each}}
{{/if}}
{{#if $aspects.aspect_docker_container.networks}}
    networks:
{{#each $aspects.aspect_docker_container.networks}}
      - {{this}}
{{/each}}
{{/if}}
{{#if $aspects.aspect_docker_container.depends_on}}
    depends_on:
{{#each $aspects.aspect_docker_container.depends_on}}
      - {{this}}
{{/each}}
{{else}}{{#if relations.[manages/managed_by]}}
    depends_on:
{{#each relations.[manages/managed_by]}}
      - {{this}}
{{/each}}
{{else}}{{#if relations.[monitors/monitored_by]}}
    depends_on:
{{#each relations.[monitors/monitored_by]}}
      - {{this}}
{{/each}}
{{/if}}{{/if}}{{/if}}
{{#if $aspects.aspect_docker_container.healthcheck}}
    healthcheck:
      test: [{{#each $aspects.aspect_docker_container.healthcheck.test}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
{{#if $aspects.aspect_docker_container.healthcheck.interval}}
      interval: {{$aspects.aspect_docker_container.healthcheck.interval}}
{{/if}}
{{#if $aspects.aspect_docker_container.healthcheck.timeout}}
      timeout: {{$aspects.aspect_docker_container.healthcheck.timeout}}
{{/if}}
{{#if $aspects.aspect_docker_container.healthcheck.retries}}
      retries: {{$aspects.aspect_docker_container.healthcheck.retries}}
{{/if}}
{{#if $aspects.aspect_docker_container.healthcheck.start_period}}
      start_period: {{$aspects.aspect_docker_container.healthcheck.start_period}}
{{/if}}
{{/if}}
{{#if $aspects.aspect_docker_container.deploy}}
    deploy:
{{#if $aspects.aspect_docker_container.deploy.resources}}
      resources:
{{#if $aspects.aspect_docker_container.deploy.resources.limits}}
        limits:
{{#if $aspects.aspect_docker_container.deploy.resources.limits.cpus}}
          cpus: '{{$aspects.aspect_docker_container.deploy.resources.limits.cpus}}'
{{/if}}
{{#if $aspects.aspect_docker_container.deploy.resources.limits.memory}}
          memory: {{$aspects.aspect_docker_container.deploy.resources.limits.memory}}
{{/if}}
{{/if}}
{{#if $aspects.aspect_docker_container.deploy.resources.reservations}}
        reservations:
{{#if $aspects.aspect_docker_container.deploy.resources.reservations.cpus}}
          cpus: '{{$aspects.aspect_docker_container.deploy.resources.reservations.cpus}}'
{{/if}}
{{#if $aspects.aspect_docker_container.deploy.resources.reservations.memory}}
          memory: {{$aspects.aspect_docker_container.deploy.resources.reservations.memory}}
{{/if}}
{{/if}}
{{/if}}
{{/if}}
{{/unless}}{{/if}}{{/if}}{{/each}}

networks:
{{#each $instances_by_id}}{{#if (exists $aspects)}}{{#if (has $aspects "aspect_docker_network")}}{{#unless (eq $id "global")}}
  {{$id}}:
{{#if $aspects.aspect_docker_network.driver}}
    driver: {{$aspects.aspect_docker_network.driver}}
{{/if}}
{{/unless}}{{/if}}{{/if}}{{/each}}

volumes:
{{#each $instances_by_id}}{{#if (exists $aspects)}}{{#if (has $aspects "aspect_docker_volume")}}{{#unless (eq $id "global")}}
  {{$id}}:
{{#if $aspects.aspect_docker_volume.driver}}
    driver: {{$aspects.aspect_docker_volume.driver}}
{{/if}}
{{/unless}}{{/if}}{{/if}}{{/each}}
